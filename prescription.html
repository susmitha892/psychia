
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient Prescription</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3a86d7;
            --secondary-color: #28a745;
            --bg-light: #F3F4F6;
            --bg-white: #FFFFFF;
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --border-color: #E5E7EB;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --neu-bg: #ecf0f3;
            --neu-shadow-1: 6px 6px 10px #d1d9e6, -6px -6px 10px rgba(226, 226, 227, 0.5);
            --neu-shadow-2: inset 1px 1px 1px #d1d9e6, inset -1px -1px 1px rgba(224, 241, 254, 0.5);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--neu-bg);
            color: var(--text-dark);
            min-height: 100vh;
        }
        .main-container {
            width: 95%;
            max-width: 900px;
            margin: 120px auto 40px;
            padding: 40px;
            background: var(--neu-bg);
            border-radius: 20px;
            box-shadow: var(--neu-shadow-1);
        }
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--neu-bg);
            box-shadow: 6px 6px 10px #d1d9e6, -6px -6px 10px rgba(226, 226, 227, 0.5);
            padding: 0 15px;
            margin: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            z-index: 100;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f0f0f;
            font-family: 'Rowdies', sans-serif;
        }
        .log {
            color: #19c541;
        }
        .nav-links {
            display: flex;
            align-items: center;
        }
        .nav-links a, .dropdown-link {
            color: #000000;
            text-decoration: none;
            margin: 0 15px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }
        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logout-btn {
            background: linear-gradient(135deg, #FF7043, #D84315);
            color: white;
            margin-right: -2px;
            padding: 8px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            filter: brightness(1.1);
        }
        .prescription-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
        }
        .prescription-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-color);
        }
        .prescription-section {
            background-color: var(--bg-light);
            padding: 25px;
            border-radius: 15px;
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        .prescription-section h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--primary-color);
        }
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .data-item {
            font-weight: 600;
            color: var(--text-dark);
        }
        .data-item span {
            font-weight: 400;
            color: var(--text-light);
            word-wrap: break-word;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .medication-table, .lab-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .medication-table th, .medication-table td,
        .lab-table th, .lab-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
        }
        .medication-table th, .lab-table th {
            background-color: #e2eaf0;
            font-weight: 600;
        }
        .btn-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s ease;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            filter: brightness(1.1);
        }
        .uploaded-file-link {
            color: var(--primary-color);
            text-decoration: underline;
            cursor: pointer;
        }
        @media print {
            body {
                background: none;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .top-nav, .btn-container {
                display: none;
            }
            .main-container {
                box-shadow: none;
                margin: 0;
                padding: 0;
                width: 100%;
            }
            .prescription-section, .prescription-header {
                box-shadow: none;
                border-radius: 0;
                background: none;
            }
        }
        .btn-download {
    background: linear-gradient(135deg, #374151, #111827); /* dark gray/black gradient */
    color: white;
    padding: 12px 25px;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.btn-download:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    filter: brightness(1.1);
}

    </style>
</head>
<body>
    <header class="top-nav">
        <div class="logo">Psychia<span class="log">try</span></div>
        <nav class="nav-links">
            <a href="{{ url_for('psychiatry_dashboard') }}">Home</a>
        </nav>
        <div class="user-menu">
    <span>{{ session.username }} ({{ session.user_role }})</span>
    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
</div>
    </header>

    <main class="main-container">
        <div class="prescription-header">
            <h1>Psychiatric Prescription</h1>
        </div>

        <div class="prescription-section">
            <h3>Patient Details</h3>
            <div class="data-grid">
                <div class="patient-info">Patient ID: <span id="patient-uhid-display">{{ patient.uhid }}</span></div>
                <div class="date-display">
    <p><strong>Visit Date:</strong> {{ visiting_date.strftime('%Y-%m-%d') }}</p>
</div>
                 <div class="patient-info">Name: <span id="patient-name-display">{{ patient.name }}</span></div>
                <div class="data-item">Age: <span id="age-data">{{ patient.age }}</span></div>
                <div class="data-item">Gender: <span id="gender-data">{{ patient.gender }}</span></div>
                <div class="data-item">Mobile: <span id="phone-data">{{ patient.mobile_no }}</span></div>
                <div class="data-item">Email: <span id="email-data">{{ patient.email }}</span></div>
                <div class="data-item">Address: <span id="address-data">{% if assessment %}{{ assessment.demographics.address }}{% endif %}</span></div>
                <div class="data-item">Occupation: <span id="occupation-data">{% if assessment %}{{ assessment.demographics.occupation }}{% endif %}</span></div>
                <div class="data-item">Marital Status: <span id="marital-data">{% if assessment %}{{ assessment.demographics.marital_status }}{% endif %}</span></div>
                <div class="data-item">Religion: <span id="religion-data">{% if assessment %}{{ assessment.demographics.religion }}{% endif %}</span></div>
                <div class="data-item">Education: <span id="education-data">{% if assessment %}{{ assessment.demographics.education }}{% endif %}</span></div>
            </div>
        </div>

        <div class="prescription-section">
            <h3>Vital Signs</h3>
            <div class="data-grid">
                
                <div class="data-item">Sugar: <span id="sugar-data">{{ patient.sugar }}</span></div>
                <div class="data-item">Height: <span id="height-data">{{ patient.height }}</span></div>
                <div class="data-item">Weight: <span id="weight-data">{{ patient.weight }}</span></div>
                <div class="data-item">Temperature: <span id="temp-data">{{ patient.temperature }}</span></div>
            </div>
        </div>

        <div class="prescription-section">
            <h3>Assessment Summary</h3>
            <div class="data-grid">
                {% if assessment and assessment.chief_complaints %}
                    <div class="data-item full-width">
                        Chief Complaints:
                        {% for complaint in assessment.chief_complaints.complaints %}
                            <span>{{ complaint }}</span>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </div>
                    <p><strong>Chief Complaints:</strong> {{ assessment.chief_complaints|join(', ') }}</p>
                    <div class="data-item">Duration: <span>{{ assessment.chief_complaints.duration }}</span></div>
                    <div class="data-item">Mode of Onset: <span>{{ assessment.chief_complaints.mode_of_onset }}</span></div>
                    <div class="data-item">Course: <span>{{ assessment.chief_complaints.course }}</span></div>
                    <div class="data-item">Precipitating Factors: <span>{{ assessment.chief_complaints.precipitating_factors }}</span></div>
                {% endif %}

                {% if assessment and assessment.history %}
                    <div class="data-item full-width">History of Present Illness: <span>{{ assessment.history.history_present_illness }}</span></div>
                    <div class="data-item full-width">Negative History: <span>{{ assessment.history.negative_history }}</span></div>
                    <div class="data-item full-width">Medical History: <span>{{ assessment.history.medical_history }}</span></div>
                    <div class="data-item full-width">Family History: <span>{{ assessment.history.family_history }}</span></div>
                {% endif %}

                {% if assessment and assessment.personal_history %}
                    <div class="data-item full-width">
                        Personal History:
                        <div class="data-grid" style="margin-top: 10px;">
                            <div class="data-item">Birth and Development: <span>{{ assessment.personal_history.birth_and_development }}</span></div>
                            <div class="data-item">Mother's Antenatal Period: <span>{{ assessment.personal_history.mother_antenatal_period }}</span></div>
                            <div class="data-item">Birth History: <span>{{ assessment.personal_history.birth_history }}</span></div>
                            <div class="data-item">Birth Weight: <span>{{ assessment.personal_history.birth_weight }}</span></div>
                            <div class="data-item">Developmental Milestones: <span>{{ assessment.personal_history.developmental_milestones }}</span></div>
                            <div class="data-item">Childhood History: <span>{{ assessment.personal_history.childhood_history }}</span></div>
                            <div class="data-item">Education & Occupation History: <span>{{ assessment.personal_history.education_occupation }}</span></div>
                            <div class="data-item">Sexual History: <span>{{ assessment.personal_history.sexual_history }}</span></div>
                            <div class="data-item">Sexual Orientation: <span>{{ assessment.personal_history.sexual_orientation }}</span></div>
                            <div class="data-item">Partners: <span>{{ assessment.personal_history.partners }}</span></div>
                            <div class="data-item">Dysfunction/Risk Behaviour: <span>{{ assessment.personal_history.dysfunction_risk }}</span></div>
                            <div class="data-item">Menstrual History: <span>{{ assessment.personal_history.menstrual_history }}</span></div>
                        </div>
                    </div>
                {% endif %}

                {% if assessment and assessment.premorbid_personality %}
                    <div class="data-item full-width">
                        Premorbid Personality:
                        <div class="data-grid" style="margin-top: 10px;">
                            <div class="data-item">Social Relations: <span>{{ assessment.premorbid_personality.social_relations }}</span></div>
                            <div class="data-item">hobbies_interests: <span>{{ assessment.premorbid_personality.hobbies_interests }}</span></div>
        <div class="data-item">Attitude to Work and Responsibility: <span>{{ assessment.premorbid_personality.attitude_work }}</span></div>
        <div class="data-item">Morals: <span>{{ assessment.premorbid_personality.morals }}</span></div>
        <div class="data-item">Religious: <span>{{ assessment.premorbid_personality.religious }}</span></div>
        <div class="data-item">Health Standards: <span>{{ assessment.premorbid_personality.health_standards }}</span></div>
        <div class="data-item">Prominent Traits: <span>{{ assessment.premorbid_personality.prominent_traits }}</span></div>
        
                        </div>
                    </div>
                {% endif %}
                
                {% if assessment and assessment.physical_exam %}
                    <div class="data-item full-width">
                        Physical Examination:
                        <div class="data-grid" style="margin-top: 10px;">
                            <div class="data-item">Pulse: <span>{{ assessment.physical_exam.pulse }}</span></div>
        <div class="data-item">BP: <span>{{ assessment.physical_exam.bp }}</span></div>
        <div class="data-item">Anaemia: <span>{{ assessment.physical_exam.anaemia }}</span></div>
        <div class="data-item">Jaundice: <span>{{ assessment.physical_exam.jaundice }}</span></div>
        <div class="data-item">Goitre: <span>{{ assessment.physical_exam.goitre }}</span></div>
        <div class="data-item">Lymphadenopathy: <span>{{ assessment.physical_exam.lymphadenopathy }}</span></div>
        <div class="data-item">CVS: <span>{{ assessment.physical_exam.cvs }}</span></div>
        <div class="data-item">RS: <span>{{ assessment.physical_exam.rs }}</span></div>
        <div class="data-item">ABD: <span>{{ assessment.physical_exam.abd }}</span></div>
        <div class="data-item">CNS: <span>{{ assessment.physical_exam.cns }}</span></div>
        <div class="data-item">Thyroid: <span>{{ assessment.physical_exam.thyroid }}</span></div>
                        </div>
                    </div>
                {% endif %}
                
                {% if assessment and assessment.mental_status %}
                    <div class="data-item full-width">
                        Mental Status Examination:
                        <div class="data-grid" style="margin-top: 10px;">
                            <div class="data-item">General Appearance, Behavior & Attitude: <span>{{ assessment.mental_status.general_appearance }}</span></div>
        <div class="data-item">Psychomotor Activity: <span>{{ assessment.mental_status.psychomotor_activity }}</span></div>
        <div class="data-item">Mood: <span>{{ assessment.mental_status.mood }}</span></div>
        <div class="data-item">Affect: <span>{{ assessment.mental_status.affect }}</span></div>
        <div class="data-item">Speech: <span>{{ assessment.mental_status.speech }}</span></div>
                        </div>
                    </div>
                {% endif %}

                {% if assessment and assessment.cognitive_functions %}
<div class="data-item full-width">
    <h3>Cognitive Functions</h3>
    <div class="data-grid" style="margin-top: 10px;">
        <div class="data-item">Attention & Concentration: <span>{{ assessment.cognitive_functions.attention_concentration }}</span></div>
        <div class="data-item">Orientation: <span>{{ assessment.cognitive_functions.orientation }}</span></div>
        <div class="data-item">Memory: <span>{{ assessment.cognitive_functions.memory }}</span></div>
        <div class="data-item">Arithmetic Ability: <span>{{ assessment.cognitive_functions.arithmetic_ability }}</span></div>
        <div class="data-item">Abstraction: <span>{{ assessment.cognitive_functions.abstraction }}</span></div>
        <div class="data-item">Judgement: <span>{{ assessment.cognitive_functions.judgement }}</span></div>
        <div class="data-item">Insight: <span>{{ assessment.cognitive_functions.insight }}</span></div>
    </div>
</div>
{% endif %}

                
                {% if assessment and assessment.previous_history %}
                    <div class="data-item full-width">
                        Previous History:
                        <div class="data-grid" style="margin-top: 10px;">
                            <div class="data-item">Previous Diagnosis: <span>{{ assessment.previous_history.previous_diagnosis }}</span></div>
        <div class="data-item">Adverse Effects: <span>{{ assessment.previous_history.adverse_effects }}</span></div>
        <div class="data-item">Previous Medications: <span>{{ assessment.previous_history.previous_medications }}</span></div>
                        </div>
                    </div>
                {% endif %}

                {% if assessment and assessment.scales %}
                    <div class="data-item full-width">
                        Scales & Scores:
                        <div class="data-grid" style="margin-top: 10px;">
                            {% for scale, value in assessment.scales.items() %}
            <div class="data-item">{{ scale }}: <span>{{ value }}</span></div>
        {% endfor %}
                        </div>
                    </div>
                {% endif %}

                {% if assessment and (assessment.review_patient or assessment.referral) %}
                    <div class="data-item full-width">
                        <h3>Review and Referral</h3>
                        <div class="data-grid" style="margin-top: 10px;">
                            <div class="data-item">Review Patient: <span>{{ assessment.review_patient }}{% if assessment.review_patient_details %} - {{ assessment.review_patient_details }}{% endif %}</span></div>
                            <div class="data-item">Referral: <span>{{ assessment.referral }}{% if assessment.referral_details %} - {{ assessment.referral_details }}{% endif %}</span></div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="prescription-section">
    <h3>Diagnosis & Psychotherapy</h3>
    {% if treatment %}
    <p><strong>Primary Diagnosis:</strong> {{ treatment.diagnosis.primary_diagnosis }}</p>
    <p><strong>Secondary Diagnosis:</strong> {{ treatment.diagnosis.secondary_diagnosis }}</p>
    <p><strong>Psychotherapy Plan:</strong> {{ treatment.psychotherapy.psychotherapy_plan }}</p>
    {% else %}
    <p>No treatment plan recorded.</p>
    {% endif %}
</div>

        <div class="prescription-section">
    <h3>Medications</h3>
    {% if treatment and treatment.medications %}
    <table class="medication-table">
        <thead>
            <tr>
                <th>Medication Name</th>
                <th>Dose</th>
                <th>Frequency</th>
                <th>Instruction</th>
            </tr>
        </thead>
        <tbody>
            {% for medication in treatment.medications %}
            <tr>
                <td>{{ medication.name }}</td>
                <td>{{ medication.dosage }}</td>
                <td>{{ medication.frequency }}</td>
                <td>{{ medication.instruction }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No medications prescribed.</p>
    {% endif %}
</div>

        
       {% if lab_report %}
<div class="summary-section">
    <h4>Lab Reports & Scans</h4>
    {% if lab_report.tests %}
        <h3>Tests</h3>
        
        <ul class="summary-list">
            {% for test in lab_report.tests.details %}
            <li><strong>{{ test.name }}:</strong> {{ test.value }}</li>
            {% endfor %}
        </ul>
        {% if lab_report.tests.summary %}
            <p><strong>Test Summary:</strong> {{ lab_report.tests.summary }}</p>
        {% endif %}
    {% endif %}
    
    {% if lab_report.scans %}
        <h3>Scans</h3>
        
        {% if lab_report.scans.name %}
            <p><strong>Scan Name:</strong> {{ lab_report.scans.name }}</p>
        {% endif %}
        {% if lab_report.scans.summary %}
            <p><strong>Scan Summary:</strong> {{ lab_report.scans.summary }}</p>
        {% endif %}

        {% if lab_report.scans.tests_file %}
            <p><strong>Tests File:</strong> <a href="{{ url_for('static', filename='uploads/' + lab_report.scans.tests_file) }}" target="_blank">{{ lab_report.scans.tests_file }}</a></p>
        {% endif %}
        {% if lab_report.scans.scans_file %}
            <p><strong>Scans File:</strong> <a href="{{ url_for('static', filename='uploads/' + lab_report.scans.scans_file) }}" target="_blank">{{ lab_report.scans.scans_file }}</a></p>
        {% endif %}
    {% endif %}
</div>
{% endif %}
<div class="btn-container">
    <button class="btn btn-primary" onclick="window.print()">
        <i class="fas fa-print"></i> Print
    </button>
    <a class="btn btn-download" href="{{ url_for('download_prescription_pdf', uhid=patient.uhid) }}">
        <i class="fas fa-download"></i> Download
    </a>
    <!-- ✅ New Save Button -->
    <form method="POST" action="{{ url_for('save_prescription', uhid=patient.uhid) }}" style="display:inline;">
        <input type="hidden" name="visiting_date" value="{{ visiting_date.strftime('%Y-%m-%d') }}">
        <button type="submit" class="btn btn-secondary">
            <i class="fas fa-save"></i> Save
        </button>
    </form>
</div>

</div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Button actions
        document.getElementById('download-btn').addEventListener('click', () => {
            // Trigger the browser's print function, which allows saving as a PDF
            window.print();
        });

        document.getElementById('print-btn').addEventListener('click', () => {
            window.print();
        }
    );

</script>
</body>
</html>